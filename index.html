<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Infoskjerm</title>
    <meta http-equiv="refresh" content="3600">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #e8a83e;
            --accent-glow: rgba(232, 168, 62, 0.25);
            --accent-dim: #b8842e;
            --sport: #4ea8de;
            --finance: #4ade80;
            --bg-deep: #08090c;
            --bg-panel: #0f1115;
            --bg-card: #161920;
            --border: rgba(255, 255, 255, 0.06);
            --border-accent: rgba(232, 168, 62, 0.2);
            --text-primary: #f0ece4;
            --text-secondary: #8a8d96;
            --text-dim: #4e515a;
            --font-display: 'Sora', system-ui, sans-serif;
            --font-body: 'DM Sans', system-ui, sans-serif;
            --radius: 14px;
            --radius-sm: 10px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%; overflow: hidden;
            background: var(--bg-deep);
            color: var(--text-primary);
            font-family: var(--font-body);
            -webkit-font-smoothing: antialiased;
            cursor: none;
        }

        /* ═══ LAYOUT ═══ */
        .screen {
            display: grid;
            grid-template-columns: 1fr 440px;
            grid-template-rows: 1fr 100px;
            grid-template-areas:
                "left-col widgets"
                "ticker ticker";
            height: 100vh; width: 100vw;
        }

        .left-col {
            grid-area: left-col;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* ═══ HERO ═══ */
        .hero-story {
            position: relative; height: 380px; min-height: 380px;
            overflow: hidden; border-bottom: 1px solid var(--border);
        }

        .hero-card {
            position: absolute; inset: 0;
            display: grid; grid-template-columns: 460px 1fr;
            gap: 32px; padding: 28px 36px;
            opacity: 0; transition: opacity 1s ease;
        }
        .hero-card.active { opacity: 1; }

        .hero-img-wrap {
            position: relative; border-radius: var(--radius);
            overflow: hidden; background: var(--bg-card);
        }
        .hero-img-wrap img {
            width: 100%; height: 100%; object-fit: cover; display: block;
            animation: hero-kb 30s ease-in-out infinite alternate;
        }
        @keyframes hero-kb {
            0%   { transform: scale(1) translate(0, 0); }
            100% { transform: scale(1.08) translate(-1%, -0.5%); }
        }
        .hero-img-wrap .hero-no-img {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 5rem; opacity: 0.1; animation: none;
        }

        .hero-badge {
            position: absolute; top: 14px; left: 14px;
            font-family: var(--font-display);
            font-size: 0.8rem; font-weight: 700;
            letter-spacing: 2px; text-transform: uppercase;
            padding: 6px 14px; border-radius: 6px; z-index: 2;
        }
        .hero-badge.news-badge { background: var(--accent); color: var(--bg-deep); }
        .hero-badge.sport-badge { background: var(--sport); color: var(--bg-deep); }

        .hero-text {
            display: flex; flex-direction: column;
            justify-content: center; gap: 12px; min-width: 0;
        }
        .hero-source {
            font-family: var(--font-display); font-size: 0.9rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
        }
        .hero-source.sport { color: var(--sport); }

        .hero-title {
            font-family: var(--font-display); font-size: 2.5rem; font-weight: 700;
            line-height: 1.2; color: var(--text-primary);
            display: -webkit-box; -webkit-line-clamp: 3;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .hero-desc {
            font-size: 1.35rem; line-height: 1.5; color: var(--text-secondary);
            display: -webkit-box; -webkit-line-clamp: 3;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .hero-time { font-size: 1rem; color: var(--text-dim); margin-top: auto; }

        .hero-divider {
            position: absolute; bottom: 0; left: 36px; right: 36px; height: 1px;
            background: linear-gradient(to right, var(--border-accent), var(--border), transparent);
        }
        .hero-progress {
            position: absolute; bottom: 10px; left: 28px; right: 28px;
            display: flex; gap: 4px; z-index: 6;
        }
        .hero-prog-seg {
            flex: 1; height: 3px; border-radius: 2px;
            background: rgba(255,255,255,0.12); overflow: hidden;
        }
        .hero-prog-fill {
            height: 100%; width: 0%; border-radius: 2px;
            background: var(--accent);
        }
        .hero-prog-seg.done .hero-prog-fill { width: 100%; }
        .hero-prog-seg.active .hero-prog-fill {
            animation: hero-prog-fill linear forwards;
        }
        @keyframes hero-prog-fill { from { width: 0%; } to { width: 100%; } }

        /* ═══ FEED ═══ */
        .feed { flex: 1; position: relative; overflow: hidden; }
        .feed-scroll { position: absolute; inset: 0; overflow: hidden; }
        .feed-track {
            display: flex; flex-direction: column; padding: 8px 0 20px 0;
            will-change: transform;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .feed-fade-bottom {
            position: absolute; left: 0; right: 0; bottom: 0; height: 60px;
            background: linear-gradient(to top, var(--bg-deep), transparent);
            z-index: 5; pointer-events: none;
        }

        .article {
            display: grid; grid-template-columns: 200px 1fr;
            gap: 18px; padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            opacity: 0; transform: translateY(16px);
            animation: fadeInArticle 0.5s ease forwards;
        }
        .article:nth-child(1) { animation-delay: 0.05s; }
        .article:nth-child(2) { animation-delay: 0.1s; }
        .article:nth-child(3) { animation-delay: 0.15s; }
        .article:nth-child(4) { animation-delay: 0.2s; }
        .article:nth-child(5) { animation-delay: 0.25s; }
        .article:nth-child(6) { animation-delay: 0.3s; }
        .article:nth-child(7) { animation-delay: 0.35s; }
        .article:nth-child(8) { animation-delay: 0.4s; }
        @keyframes fadeInArticle { to { opacity: 1; transform: translateY(0); } }

        .article-text {
            display: flex; flex-direction: column;
            justify-content: center; gap: 5px; min-width: 0;
        }
        .article-source {
            font-family: var(--font-display); font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent);
        }
        .article-source.sport { color: var(--sport); }

        .article-title {
            font-family: var(--font-display); font-size: 1.35rem; font-weight: 600;
            line-height: 1.3; color: var(--text-primary);
            display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .article-desc {
            font-size: 1.05rem; line-height: 1.4; color: var(--text-secondary);
            display: -webkit-box; -webkit-line-clamp: 1;
            -webkit-box-orient: vertical; overflow: hidden;
        }
        .article-time { font-size: 0.85rem; color: var(--text-dim); }

        .article-img {
            width: 200px; height: 125px; border-radius: var(--radius-sm);
            overflow: hidden; background: var(--bg-card);
        }
        .article-img img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .article-img.no-image {
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; opacity: 0.12;
        }

        /* ═══ WIDGETS ═══ */
        .widgets {
            grid-area: widgets; background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex; flex-direction: column;
            padding: 16px 18px 10px; gap: 10px;
            overflow: hidden; position: relative;
        }
        .widgets::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 160px;
            background: linear-gradient(135deg, rgba(232,168,62,0.04) 0%, transparent 60%);
            pointer-events: none;
        }

        .widget-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 12px 16px; position: relative;
        }
        .widget-label {
            font-family: var(--font-display); font-size: 0.8rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 2px;
            color: var(--accent); margin-bottom: 6px;
            display: flex; align-items: center; gap: 8px;
        }
        .widget-label-line {
            flex: 1; height: 1px;
            background: linear-gradient(to right, var(--border-accent), transparent);
        }

        /* Clock */
        .clock-time {
            font-family: var(--font-display); font-size: 4.2rem; font-weight: 700;
            letter-spacing: -2px; line-height: 1;
        }
        .clock-colon { animation: blink 2s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .clock-seconds {
            font-size: 1.6rem; font-weight: 300; opacity: 0.3;
            margin-left: 2px; vertical-align: super;
        }
        .clock-date {
            font-family: var(--font-display); font-size: 1.2rem;
            color: var(--text-secondary); margin-top: 4px; text-transform: capitalize;
        }
        .clock-week { font-size: 0.95rem; color: var(--text-dim); font-family: var(--font-display); }

        /* Weather */
        .weather-row { display: flex; align-items: center; gap: 12px; }
        .weather-icon { font-size: 2.6rem; line-height: 1; }
        .weather-temp { font-family: var(--font-display); font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .weather-desc { font-size: 1.05rem; color: var(--text-secondary); }
        .weather-detail { font-size: 0.85rem; color: var(--text-dim); }
        .weather-location { font-size: 0.8rem; color: var(--text-dim); margin-top: 1px; }


        /* Daily Image */
        .daily-img-widget {
            position: relative; overflow: hidden; border-radius: var(--radius-sm);
            aspect-ratio: 2.2 / 1; background: var(--bg-deep);
        }
        .di-slide {
            position: absolute; inset: 0; opacity: 0; transition: opacity 1.5s ease;
        }
        .di-slide.active { opacity: 1; }
        .di-slide img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .di-slide.kb-a img { animation: kb-a 18s ease-in-out forwards; }
        .di-slide.kb-b img { animation: kb-b 18s ease-in-out forwards; }
        @keyframes kb-a { 0% { transform: scale(1); } 100% { transform: scale(1.12) translate(-1.5%, -1%); } }
        @keyframes kb-b { 0% { transform: scale(1.1) translate(-1%, 1%); } 100% { transform: scale(1) translate(1%, -0.5%); } }

        .di-caption {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px 12px 8px;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
            font-family: var(--font-display); font-size: 0.8rem;
            color: rgba(255,255,255,0.7); letter-spacing: 0.5px; z-index: 2;
        }
        .di-dots {
            position: absolute; bottom: 7px; right: 10px;
            display: flex; gap: 4px; z-index: 3;
        }
        .di-dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: rgba(255,255,255,0.25); transition: all 0.4s ease;
        }
        .di-dot.active { background: var(--accent); width: 14px; border-radius: 3px; }

        /* Events */
        .events-list { display: flex; flex-direction: column; gap: 5px; }
        .event-item {
            display: flex; align-items: center; gap: 10px;
            padding: 4px 0; border-bottom: 1px solid var(--border);
        }
        .event-item:last-child { border-bottom: none; }
        .event-icon {
            width: 34px; height: 34px; min-width: 34px; border-radius: 6px;
            overflow: hidden; background: var(--bg-deep);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; line-height: 1;
        }
        .event-icon img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .event-info { flex: 1; min-width: 0; }
        .event-title {
            font-family: var(--font-display); font-size: 0.9rem; font-weight: 600;
            line-height: 1.3; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .event-meta { font-size: 0.75rem; color: var(--text-dim); }
        .event-date {
            font-family: var(--font-display); font-size: 0.7rem; font-weight: 600;
            color: var(--accent); white-space: nowrap;
        }

        /* Bus Departures */
        .bus-stop-name {
            font-size: 0.75rem; color: var(--text-dim);
            font-family: var(--font-display); margin-bottom: 4px;
        }
        .bus-stop-name::before { content: '\1F68F  '; }
        .bus-list { display: flex; flex-direction: column; gap: 4px; }
        .bus-item {
            display: flex; align-items: center; gap: 10px;
            padding: 5px 0; border-bottom: 1px solid var(--border);
        }
        .bus-item:last-child { border-bottom: none; }
        .bus-line {
            font-family: var(--font-display); font-size: 0.85rem; font-weight: 700;
            background: var(--accent); color: var(--bg-deep);
            padding: 3px 8px; border-radius: 5px; min-width: 42px;
            text-align: center; white-space: nowrap;
        }
        .bus-dest {
            flex: 1; min-width: 0;
            font-family: var(--font-display); font-size: 0.9rem; font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .bus-time {
            font-family: var(--font-display); font-size: 0.95rem; font-weight: 700;
            color: var(--text-primary); white-space: nowrap;
        }
        .bus-time .bus-rt {
            display: inline-block; width: 6px; height: 6px; border-radius: 50%;
            background: #4ade80; margin-right: 3px; vertical-align: middle;
        }
        .bus-time-dim { color: var(--text-secondary); font-weight: 400; font-size: 0.8rem; }

        /* Branding + Status */
        .branding {
            margin-top: auto; padding-top: 6px;
            border-top: 1px solid var(--border);
            text-align: right;
        }
        .brand-row { margin-bottom: 5px; }
        .brand-name {
            font-family: var(--font-display); font-size: 1.05rem; font-weight: 700;
            color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase;
        }
        .brand-by {
            font-size: 0.6rem; font-weight: 400; opacity: 0.5; letter-spacing: 1px;
        }
        .source-status { display: flex; flex-wrap: wrap; gap: 4px 8px; justify-content: flex-end; }
        .last-refresh {
            font-size: 0.65rem; color: var(--text-dim); opacity: 0.5;
            font-family: var(--font-display); margin-top: 4px; letter-spacing: 0.5px;
        }
        .source-dot {
            display: flex; align-items: center; gap: 4px;
            font-size: 0.7rem; color: var(--text-dim);
            font-family: var(--font-display); letter-spacing: 0.3px;
        }
        .source-dot .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--text-dim); transition: background 0.4s ease;
        }
        .source-dot .dot.ok { background: #4ade80; }
        .source-dot .dot.error { background: #f87171; }
        .source-dot .dot.loading {
            background: var(--accent);
            animation: pulse-dot 1s ease-in-out infinite;
        }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* ═══ TICKER ═══ */
        .ticker-bar {
            grid-area: ticker; background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex; align-items: center; overflow: hidden;
        }
        .ticker-label {
            display: flex; align-items: center; gap: 8px;
            padding: 0 24px 0 28px;
            font-family: var(--font-display); font-size: 1.05rem; font-weight: 700;
            letter-spacing: 3px; text-transform: uppercase;
            color: var(--bg-deep); background: var(--accent);
            height: 100%; white-space: nowrap; position: relative; z-index: 2;
        }
        .ticker-label::after {
            content: ''; position: absolute;
            right: -24px; top: 0; bottom: 0; width: 24px;
            background: linear-gradient(to right, rgba(232,168,62,0.4), transparent);
        }
        .ticker-live-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: var(--bg-deep); animation: pulse-dot 1.5s ease-in-out infinite;
        }

        .ticker-track {
            flex: 1; overflow: hidden; height: 100%;
            display: flex; align-items: center;
            mask-image: linear-gradient(to right, transparent, black 50px, black calc(100% - 50px), transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 50px, black calc(100% - 50px), transparent);
        }
        .ticker-content {
            display: flex; white-space: nowrap; will-change: transform;
            font-size: 1.5rem; color: var(--text-primary);
        }
        .ticker-content span { padding: 0 24px; }
        .ticker-content .sep {
            color: var(--accent); font-size: 0.6rem; padding: 0 16px; opacity: 0.6;
            display: inline-flex; align-items: center;
        }
        .ticker-content .fin-item {
            color: var(--finance); display: inline-flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 0 6px; line-height: 1;
        }
        .ticker-content .fin-val {
            font-family: var(--font-display); font-weight: 700;
            font-size: 1.4rem;
        }
        .ticker-content .fin-cur {
            font-family: var(--font-display); font-weight: 600;
            font-size: 0.55rem; opacity: 0.6; letter-spacing: 1px;
            margin-top: 2px;
        }
        /* ═══ LOADING & AMBIENT ═══ */
        .loading-overlay {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; gap: 16px;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }
        .loading-overlay.hidden { opacity: 0; visibility: hidden; }
        .loading-spinner {
            width: 36px; height: 36px; border: 2px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text {
            font-family: var(--font-display); font-size: 1rem;
            letter-spacing: 3px; text-transform: uppercase; color: var(--text-dim);
        }

        .ambient-orb {
            position: fixed; border-radius: 50%;
            filter: blur(120px); pointer-events: none; z-index: 0;
        }
        .orb-1 {
            width: 400px; height: 400px; background: var(--accent);
            top: -100px; right: 200px; opacity: 0.05;
            animation: float-orb 20s ease-in-out infinite;
        }
        .orb-2 {
            width: 300px; height: 300px; background: #3a6bdb;
            bottom: -50px; left: 25%; opacity: 0.03;
            animation: float-orb 25s ease-in-out infinite reverse;
        }
        @keyframes float-orb {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(30px, -20px); }
            66% { transform: translate(-20px, 15px); }
        }
    </style>
</head>
<body>

<div class="ambient-orb orb-1"></div>
<div class="ambient-orb orb-2"></div>

<div class="loading-overlay" id="loading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Laster infoskjerm</div>
</div>

<div class="screen">

    <div class="left-col">
        <div class="hero-story" id="hero-story">
            <div class="hero-divider"></div>
        </div>
        <div class="feed">
            <div class="feed-scroll">
                <div class="feed-track" id="feed-track"></div>
            </div>
            <div class="feed-fade-bottom"></div>
        </div>
    </div>

    <div class="widgets">
        <div class="widget-card">
            <div class="clock-time">
                <span id="clock-h">00</span><span class="clock-colon">:</span><span id="clock-m">00</span><span class="clock-seconds" id="clock-s">00</span>
            </div>
            <div class="clock-date" id="clock-date"></div>
            <div class="clock-week" id="clock-week"></div>
        </div>

        <div class="widget-card">
            <div class="widget-label">V&aelig;r <span class="widget-label-line"></span></div>
            <div class="weather-row">
                <div class="weather-icon" id="weather-icon">--</div>
                <div>
                    <div class="weather-temp" id="weather-temp">--</div>
                    <div class="weather-desc" id="weather-desc">Henter&hellip;</div>
                </div>
                <div style="margin-left:auto; text-align:right;">
                    <div class="weather-detail" id="weather-detail"></div>
                    <div class="weather-location" id="weather-location">Stavanger</div>
                </div>
            </div>
        </div>

        <div class="widget-card" style="padding:0; border:none; background:none;">
            <div class="daily-img-widget" id="daily-images"></div>
        </div>

        <div class="widget-card">
            <div class="widget-label">Hva skjer <span class="widget-label-line"></span></div>
            <div class="events-list" id="events-list"></div>
        </div>

        <div class="widget-card">
            <div class="widget-label">Buss avganger <span class="widget-label-line"></span></div>
            <div class="bus-stop-name" id="bus-stop-name"></div>
            <div class="bus-list" id="bus-list">
                <div style="color:var(--text-dim);font-size:0.85rem;">Henter avganger&hellip;</div>
            </div>
        </div>

        <div class="branding">
            <div class="brand-row">
                <div class="brand-name"><span class="brand-by">made by </span>pelifix</div>
            </div>
            <div class="source-status" id="source-status"></div>
            <div class="last-refresh" id="last-refresh"></div>
        </div>
    </div>

    <div class="ticker-bar">
        <div class="ticker-label">
            <div class="ticker-live-dot"></div>
            Direkte
        </div>
        <div class="ticker-track">
            <div class="ticker-content" id="ticker-content">
                <span>Henter nyheter&hellip;</span>
            </div>
        </div>
    </div>

</div>

<script>
(function() {
    'use strict';

    var CONFIG = {
        corsProxy: 'https://api.codetabs.com/v1/proxy/?quest=',
        rssApi: 'https://api.rss2json.com/v1/api.json?rss_url=',
        feeds: {
            news: 'https://www.nrk.no/toppsaker.rss',
            sport: 'https://www.nrk.no/sport/toppsaker.rss',
            e24: 'https://e24.no/rss2/',
            aftenbladet: 'https://www.aftenbladet.no/rss',
            aftenbladSport: 'https://www.aftenbladet.no/sport/rss',
            vg: 'https://www.vg.no/rss/feed/',
            vgSport: 'https://www.vg.no/rss/feed/?categories=sport',
        },
        feedRefresh: 5 * 60 * 1000,
        feedScrollInterval: 5000,
        tickerSpeed: 1.2,
        slideInterval: 12000,
        heroInterval: 10000,
        heroCount: 5,
        weatherLat: 58.97,
        weatherLon: 5.73,
        weatherLocation: 'Stavanger, Norge',
        weatherRefresh: 30 * 60 * 1000,
        financeRefresh: 30 * 60 * 1000,
        eventsRefresh: 6 * 60 * 60 * 1000,
        imageRefresh: 60 * 60 * 1000,
        webcams: [
            { src: 'https://kamera.atlas.vegvesen.no/api/images/1129023_1', caption: 'Vegkamera \u2014 E39 Forus' },
            { src: 'https://kamera.atlas.vegvesen.no/api/images/1229047_1', caption: 'Vegkamera \u2014 Stavanger' },
        ],
        busStop: 'NSR:StopPlace:26354',
        busStopName: 'Vestre Svanholmen',
        busDepartures: 5,
        busRefresh: 60 * 1000,
    };

    /* ═══ SOURCE STATUS TRACKING ═══ */
    var SOURCES = {
        nyheter:     { label: 'NRK',         status: 'pending' },
        sport:       { label: 'NRK Sport',   status: 'pending' },
        e24:         { label: 'E24',         status: 'pending' },
        aftenbladet: { label: 'Aftenbladet', status: 'pending' },
        aftenbladSport: { label: 'Aft. Sport', status: 'pending' },
        vg:          { label: 'VG',          status: 'pending' },
        vgSport:     { label: 'VG Sport',    status: 'pending' },
        ticker:      { label: 'Ticker',      status: 'pending' },
        marked:      { label: 'Marked',      status: 'pending' },
        vaer:        { label: 'V\u00e6r',    status: 'pending' },
        bilder:      { label: 'Bilder',      status: 'pending' },
        buss:        { label: 'Buss',        status: 'pending' },
        konserthus:  { label: 'Konserthus',  status: 'pending' },
        folken:      { label: 'Folken',      status: 'pending' },
    };

    var FEED_META = {
        news:        { srcKey: 'nyheter',     label: 'NRK',         sport: false },
        sport:       { srcKey: 'sport',       label: 'NRK Sport',   sport: true },
        e24:         { srcKey: 'e24',         label: 'E24',         sport: false },
        aftenbladet: { srcKey: 'aftenbladet', label: 'Aftenbladet', sport: false },
        aftenbladSport: { srcKey: 'aftenbladSport', label: 'Aft. Sport', sport: true },
        vg:          { srcKey: 'vg',          label: 'VG',          sport: false },
        vgSport:     { srcKey: 'vgSport',     label: 'VG Sport',    sport: true },
    };

    var lastRefreshTime = null;

    function setSource(key, status) {
        SOURCES[key].status = status;
        if (status === 'ok') lastRefreshTime = new Date();
        renderSourceStatus();
    }

    function renderSourceStatus() {
        var el = document.getElementById('source-status');
        if (!el) return;
        el.innerHTML = Object.keys(SOURCES).map(function(key) {
            var s = SOURCES[key];
            return '<div class="source-dot"><div class="dot ' + s.status + '"></div>' + s.label + '</div>';
        }).join('');
        var refreshEl = document.getElementById('last-refresh');
        if (refreshEl && lastRefreshTime) {
            refreshEl.textContent = 'Sist oppdatert: ' +
                String(lastRefreshTime.getHours()).padStart(2, '0') + ':' +
                String(lastRefreshTime.getMinutes()).padStart(2, '0') + ':' +
                String(lastRefreshTime.getSeconds()).padStart(2, '0');
        }
    }

    renderSourceStatus();

    /* ═══ IMAGE SLIDESHOW (Bing + Webcams) ═══ */
    var slideImages = [];

    /* ═══ EVENTS (scraped from Konserthus + Folken) ═══ */
    var FALLBACK_EVENTS = [
        { icon: '\uD83C\uDFB5', date: 'Laster...', title: 'Henter arrangementer...', venue: 'Stavanger' },
    ];

    var FOLKEN_MONTHS = {
        'January':'01','February':'02','March':'03','April':'04',
        'May':'05','June':'06','July':'07','August':'08',
        'September':'09','October':'10','November':'11','December':'12',
    };

    function folkenIcon(type) {
        if (type === 'Comedy') return '\uD83C\uDFAD';
        if (type === 'Quiz') return '\uD83E\uDDE9';
        if (type === 'Teater') return '\uD83C\uDFAD';
        if (type === 'Film') return '\uD83C\uDFAC';
        return '\uD83C\uDFB5';
    }

    function formatISODate(isoDate) {
        if (!isoDate) return '';
        var p = isoDate.split('T')[0].split('-');
        var day = parseInt(p[2]);
        var mon = parseInt(p[1]) - 1;
        return day + '. ' + monN[mon].substring(0, 3);
    }

    function parseFolkenDate(dateText, timeText) {
        var parts = dateText.trim().split(/\s+/);
        if (parts.length < 2) return '';
        var day = parts[0].padStart(2, '0');
        var mon = FOLKEN_MONTHS[parts[1]] || '01';
        var year = new Date().getFullYear();
        var time = timeText || '00:00';
        return year + '-' + mon + '-' + day + 'T' + time;
    }

    /* ═══ HELPERS ═══ */
    var dayN = ['s\u00f8ndag','mandag','tirsdag','onsdag','torsdag','fredag','l\u00f8rdag'];
    var monN = ['januar','februar','mars','april','mai','juni','juli','august','september','oktober','november','desember'];

    function timeAgo(dateStr) {
        var diff = Date.now() - new Date(dateStr).getTime();
        var mins = Math.floor(diff / 60000);
        if (mins < 1) return 'Akkurat n\u00e5';
        if (mins < 60) return mins + ' min siden';
        var hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + ' t siden';
        return Math.floor(hrs / 24) + ' d siden';
    }

    function escapeHtml(str) {
        var d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    /* ═══ CLOCK ═══ */
    function updateClock() {
        var now = new Date();
        document.getElementById('clock-h').textContent = String(now.getHours()).padStart(2,'0');
        document.getElementById('clock-m').textContent = String(now.getMinutes()).padStart(2,'0');
        document.getElementById('clock-s').textContent = String(now.getSeconds()).padStart(2,'0');
        document.getElementById('clock-date').textContent = dayN[now.getDay()] + ' ' + now.getDate() + '. ' + monN[now.getMonth()];
        var d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var ys = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var wk = Math.ceil(((d - ys) / 86400000 + 1) / 7);
        document.getElementById('clock-week').textContent = 'Uke ' + wk + ' \u00b7 ' + now.getFullYear();
    }
    setInterval(updateClock, 1000);
    updateClock();

    /* ═══ NEWS FEED ═══ */
    var heroEl = document.getElementById('hero-story');
    var feedTrack = document.getElementById('feed-track');
    var feedItems = [];
    var feedScrollPos = 0;
    var currentHeroTitle = '';
    var heroItems = [];
    var heroIndex = 0;
    var rawFeeds = { news: [], sport: [], e24: [], aftenbladet: [], aftenbladSport: [], vg: [], vgSport: [] };

    function renderHero(item) {
        if (!item) return;
        if (item.title === currentHeroTitle) return;
        currentHeroTitle = item.title;

        var meta = FEED_META[item.source];
        var isSport = meta && meta.sport;
        var badgeClass = isSport ? 'sport-badge' : 'news-badge';
        var badgeText = meta ? meta.label : 'Siste nytt';
        var imgContent = item.image
            ? '<img src="' + escapeHtml(item.image) + '" alt="">'
            : '<div class="hero-no-img">\u{1F4F0}</div>';

        var html =
            '<div class="hero-img-wrap">' +
                '<div class="hero-badge ' + badgeClass + '">' + badgeText + '</div>' +
                imgContent +
            '</div>' +
            '<div class="hero-text">' +
                '<div class="hero-source ' + (isSport ? 'sport' : '') + '">' + badgeText + '</div>' +
                '<div class="hero-title">' + escapeHtml(item.title) + '</div>' +
                (item.desc ? '<div class="hero-desc">' + escapeHtml(item.desc) + '</div>' : '') +
                '<div class="hero-time">' + (item.pubDate ? timeAgo(item.pubDate) : '') + '</div>' +
            '</div>';

        var cards = heroEl.querySelectorAll('.hero-card');
        var newCard = document.createElement('div');
        newCard.className = 'hero-card';
        newCard.innerHTML = html;
        heroEl.insertBefore(newCard, heroEl.querySelector('.hero-divider'));
        void newCard.offsetWidth;
        newCard.classList.add('active');

        for (var i = 0; i < cards.length; i++) { cards[i].classList.remove('active'); }
        setTimeout(function() {
            var old = heroEl.querySelectorAll('.hero-card:not(.active)');
            for (var j = 0; j < old.length; j++) { old[j].parentNode.removeChild(old[j]); }
        }, 1200);
    }

    function renderHeroProgress() {
        var existing = heroEl.querySelector('.hero-progress');
        if (existing) existing.remove();
        if (heroItems.length <= 1) return;
        var bar = document.createElement('div');
        bar.className = 'hero-progress';
        var dur = (CONFIG.heroInterval / 1000) + 's';
        heroItems.forEach(function(_, i) {
            var seg = document.createElement('div');
            seg.className = 'hero-prog-seg';
            if (i < heroIndex) seg.classList.add('done');
            else if (i === heroIndex) seg.classList.add('active');
            var fill = document.createElement('div');
            fill.className = 'hero-prog-fill';
            if (i === heroIndex) fill.style.animationDuration = dur;
            seg.appendChild(fill);
            bar.appendChild(seg);
        });
        heroEl.appendChild(bar);
    }

    function updateHeroProgress() {
        var segs = heroEl.querySelectorAll('.hero-prog-seg');
        var dur = (CONFIG.heroInterval / 1000) + 's';
        for (var i = 0; i < segs.length; i++) {
            segs[i].classList.remove('done', 'active');
            var fill = segs[i].querySelector('.hero-prog-fill');
            fill.style.animation = 'none';
            fill.style.animationDuration = '';
            if (i < heroIndex) {
                segs[i].classList.add('done');
            } else if (i === heroIndex) {
                segs[i].classList.add('active');
                void fill.offsetWidth;
                fill.style.animation = '';
                fill.style.animationDuration = dur;
            }
        }
    }

    function renderFeed(items) {
        feedTrack.innerHTML = '';
        feedScrollPos = 0;
        feedTrack.style.transform = 'translateY(0)';
        if (!items.length) {
            feedTrack.innerHTML = '<div style="padding:40px 32px;color:var(--text-dim);font-size:1.1rem;">Laster nyheter&hellip;</div>';
            return;
        }
        items.forEach(function(item, i) {
            var meta = FEED_META[item.source];
            var isSport = meta && meta.sport;
            var div = document.createElement('div');
            div.className = 'article';
            var imgHtml = item.image
                ? '<div class="article-img"><img src="' + escapeHtml(item.image) + '" alt="" loading="' + (i < 4 ? 'eager' : 'lazy') + '"></div>'
                : '<div class="article-img no-image">\u{1F4F0}</div>';
            div.innerHTML = imgHtml +
                '<div class="article-text">' +
                    '<div class="article-source ' + (isSport ? 'sport' : '') + '">' + (meta ? meta.label : 'Nyheter') + '</div>' +
                    '<div class="article-title">' + escapeHtml(item.title) + '</div>' +
                    (item.desc ? '<div class="article-desc">' + escapeHtml(item.desc) + '</div>' : '') +
                    '<div class="article-time">' + (item.pubDate ? timeAgo(item.pubDate) : '') + '</div>' +
                '</div>';
            feedTrack.appendChild(div);
        });
    }

    function scrollFeed() {
        if (feedItems.length <= 4) return;
        feedScrollPos++;
        var offset = feedScrollPos * 160;
        var maxScroll = feedTrack.scrollHeight - feedTrack.parentElement.clientHeight;
        if (offset >= maxScroll) {
            feedScrollPos = 0;
            feedTrack.style.transition = 'none';
            feedTrack.style.transform = 'translateY(0)';
            void feedTrack.offsetWidth;
            feedTrack.style.transition = 'transform 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
            return;
        }
        feedTrack.style.transform = 'translateY(-' + offset + 'px)';
    }

    function mergeFeedsAndRender() {
        var merged = [];
        Object.keys(rawFeeds).forEach(function(key) { merged = merged.concat(rawFeeds[key]); });
        merged.sort(function(a, b) { return new Date(b.pubDate || 0) - new Date(a.pubDate || 0); });
        var seen = {};
        var all = [];
        for (var i = 0; i < merged.length && all.length < 25; i++) {
            var key = merged[i].title.toLowerCase().trim();
            if (seen[key]) continue;
            seen[key] = true;
            all.push(merged[i]);
        }
        if (!all.length) return;
        heroItems = all.slice(0, CONFIG.heroCount);
        feedItems = all.slice(CONFIG.heroCount);
        if (heroIndex >= heroItems.length) heroIndex = 0;
        renderHero(heroItems[heroIndex]);
        renderHeroProgress();
        renderFeed(feedItems);
    }

    async function loadFeed(type) {
        var meta = FEED_META[type];
        var srcKey = meta ? meta.srcKey : type;
        setSource(srcKey, 'loading');
        try {
            var url = CONFIG.rssApi + encodeURIComponent(CONFIG.feeds[type]);
            var resp = await fetch(url);
            if (!resp.ok) throw new Error('Feed fetch failed: ' + type);
            var data = await resp.json();
            if (data.status !== 'ok' || !data.items || !data.items.length) throw new Error('No items in feed: ' + type);
            rawFeeds[type] = data.items.slice(0, 15).map(function(item) {
                return {
                    title: item.title || '',
                    desc: (item.description || '').replace(/<[^>]*>/g, ''),
                    pubDate: item.pubDate || '',
                    image: item.thumbnail || (item.enclosure && item.enclosure.link) || null,
                    source: type,
                };
            }).filter(function(a) { return a.title; });
            mergeFeedsAndRender();
            setSource(srcKey, 'ok');
        } catch (err) {
            console.warn('Feed load error (' + type + '):', err);
            setSource(srcKey, 'error');
        }
    }

    // Stagger initial loads to avoid API rate limits
    var feedKeys = Object.keys(CONFIG.feeds);
    feedKeys.forEach(function(key, i) {
        setTimeout(function() { loadFeed(key); }, i * 1500);
        setInterval(function() { loadFeed(key); }, CONFIG.feedRefresh);
    });
    setInterval(scrollFeed, CONFIG.feedScrollInterval);
    setInterval(function() {
        if (heroItems.length <= 1) return;
        heroIndex = (heroIndex + 1) % heroItems.length;
        renderHero(heroItems[heroIndex]);
        updateHeroProgress();
    }, CONFIG.heroInterval);

    /* ═══ IMAGE SLIDESHOW ═══ */
    var diEl = document.getElementById('daily-images');
    var diIndex = 0;
    var diCaption, diDots;

    function buildSlideshow(images) {
        slideImages = images;
        diEl.innerHTML = '';
        diIndex = 0;
        images.forEach(function(img, i) {
            var div = document.createElement('div');
            div.className = 'di-slide ' + (i % 2 === 0 ? 'kb-a' : 'kb-b') + (i === 0 ? ' active' : '');
            var el = document.createElement('img');
            el.src = img.live ? img.src + (img.src.indexOf('?') >= 0 ? '#' : '?t=') + Date.now() : img.src;
            el.alt = img.caption; el.loading = i < 2 ? 'eager' : 'lazy';
            div.appendChild(el);
            diEl.appendChild(div);
        });
        diCaption = document.createElement('div');
        diCaption.className = 'di-caption';
        diCaption.textContent = images[0].caption;
        diEl.appendChild(diCaption);
        diDots = document.createElement('div');
        diDots.className = 'di-dots';
        images.forEach(function(_, i) {
            var d = document.createElement('div');
            d.className = 'di-dot' + (i === 0 ? ' active' : '');
            diDots.appendChild(d);
        });
        diEl.appendChild(diDots);
    }

    function cycleSlide() {
        if (slideImages.length <= 1) return;
        var slides = diEl.querySelectorAll('.di-slide');
        var dots = diEl.querySelectorAll('.di-dot');
        if (!slides.length) return;
        slides[diIndex].classList.remove('active');
        dots[diIndex].classList.remove('active');
        diIndex = (diIndex + 1) % slideImages.length;
        var ns = slides[diIndex];
        // Refresh live images (webcams, radar) with cache-buster
        if (slideImages[diIndex].live) {
            var img = ns.querySelector('img');
            var bust = slideImages[diIndex].src.indexOf('?') >= 0 ? '#' : '?t=';
            img.src = slideImages[diIndex].src + bust + Date.now();
        }
        ns.classList.remove('kb-a', 'kb-b');
        void ns.offsetWidth;
        ns.classList.add(diIndex % 2 === 0 ? 'kb-a' : 'kb-b');
        ns.classList.add('active');
        dots[diIndex].classList.add('active');
        diCaption.textContent = slideImages[diIndex].caption;
    }

    async function loadImages() {
        setSource('bilder', 'loading');
        var bingImgs = [];
        var liveImgs = [];
        try {
            var bingUrl = CONFIG.corsProxy + encodeURIComponent('https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=5&mkt=en-US');
            var resp = await fetch(bingUrl);
            if (resp.ok) {
                var data = await resp.json();
                if (data.images && data.images.length) {
                    data.images.forEach(function(img) {
                        var copy = img.copyright || '';
                        var caption = img.title || copy.split('(')[0].trim() || 'Bing';
                        bingImgs.push({
                            src: 'https://www.bing.com' + img.urlbase + '_1920x1080.jpg',
                            caption: caption,
                            live: false,
                        });
                    });
                }
            }
        } catch (e) { console.warn('Bing wallpaper error:', e); }
        // Radar + webcams
        liveImgs.push({
            src: 'https://api.met.no/weatherapi/radar/2.0/?type=reflectivity&area=southwestern_norway&content=animation',
            caption: 'Nedb\u00f8rsradar \u2014 S\u00f8rvestlandet',
            live: true,
        });
        CONFIG.webcams.forEach(function(wc) {
            liveImgs.push({ src: wc.src, caption: wc.caption, live: true });
        });
        // Interleave: Bing, Live, Bing, Live, ...
        var images = [];
        var bi = 0, li = 0;
        while (bi < bingImgs.length || li < liveImgs.length) {
            if (bi < bingImgs.length) images.push(bingImgs[bi++]);
            if (li < liveImgs.length) images.push(liveImgs[li++]);
        }
        if (images.length) {
            buildSlideshow(images);
            setSource('bilder', 'ok');
        } else {
            setSource('bilder', 'error');
        }
    }

    setInterval(cycleSlide, CONFIG.slideInterval);

    /* ═══ EVENTS (scraped from venue sites) ═══ */
    var eventsEl = document.getElementById('events-list');

    function renderEvents(events) {
        eventsEl.innerHTML = '';
        if (!events.length) {
            eventsEl.innerHTML = '<div style="color:var(--text-dim);font-size:0.85rem;">Ingen kommende arrangementer</div>';
            return;
        }
        events.forEach(function(ev) {
            var div = document.createElement('div');
            div.className = 'event-item';
            var iconHtml = ev.image
                ? '<img src="' + escapeHtml(ev.image) + '" alt="">'
                : ev.icon;
            div.innerHTML =
                '<div class="event-icon">' + iconHtml + '</div>' +
                '<div class="event-info">' +
                    '<div class="event-title">' + escapeHtml(ev.title) + '</div>' +
                    '<div class="event-meta">' + escapeHtml(ev.venue) + '</div>' +
                '</div>' +
                '<div class="event-date">' + ev.date + '</div>';
            eventsEl.appendChild(div);
        });
    }

    async function scrapeKonserthus() {
        var url = CONFIG.corsProxy + encodeURIComponent('https://www.stavanger-konserthus.no/program/');
        var resp = await fetch(url);
        if (!resp.ok) throw new Error('Konserthus fetch failed');
        var html = await resp.text();
        var doc = new DOMParser().parseFromString(html, 'text/html');
        var articles = doc.querySelectorAll('article.event');
        var events = [];
        for (var i = 0; i < articles.length && events.length < 6; i++) {
            var a = articles[i];
            var nameEl = a.querySelector('[itemprop="name"]');
            var dateEl = a.querySelector('[itemprop="startDate"]');
            var venueEl = a.querySelector('[itemprop="location"] [itemprop="name"]');
            if (!nameEl || !dateEl) continue;
            var imgEl = a.querySelector('img[itemprop="image"]');
            var image = imgEl ? (imgEl.getAttribute('data-src') || imgEl.getAttribute('src') || '') : '';
            events.push({
                title: nameEl.textContent.trim(),
                date: dateEl.getAttribute('content') || '',
                venue: venueEl ? venueEl.textContent.trim() : 'Konserthuset',
                icon: '\uD83C\uDFB5',
                image: image,
            });
        }
        return events;
    }

    async function scrapeFolken() {
        var url = CONFIG.corsProxy + encodeURIComponent('https://www.folken.no/folken/index.php');
        var resp = await fetch(url);
        if (!resp.ok) throw new Error('Folken fetch failed');
        var html = await resp.text();
        var doc = new DOMParser().parseFromString(html, 'text/html');
        var items = doc.querySelectorAll('.list-item');
        var events = [];
        for (var i = 0; i < items.length && events.length < 6; i++) {
            var item = items[i];
            var titleEl = item.querySelector('.title a');
            if (!titleEl) continue;
            var type = item.getAttribute('data-type') || '';
            var infoItems = item.querySelectorAll('.info-item');
            var dateText = '', timeText = '';
            for (var j = 0; j < infoItems.length; j++) {
                var txt = infoItems[j].textContent.trim();
                if (/\d{1,2}:\d{2}/.test(txt)) timeText = txt.match(/\d{1,2}:\d{2}/)[0];
                else if (/\d/.test(txt)) dateText = txt;
            }
            var imgDiv = item.querySelector('.image');
            var image = '';
            if (imgDiv) {
                var bgMatch = (imgDiv.getAttribute('style') || '').match(/url\(([^)]+)\)/);
                if (bgMatch) image = bgMatch[1];
            }
            events.push({
                title: titleEl.textContent.trim(),
                date: parseFolkenDate(dateText, timeText),
                venue: 'Folken',
                icon: folkenIcon(type),
                image: image,
            });
        }
        return events;
    }

    async function loadEvents() {
        setSource('konserthus', 'loading');
        setSource('folken', 'loading');
        try {
            var results = await Promise.allSettled([scrapeKonserthus(), scrapeFolken()]);
            var srcKeys = ['konserthus', 'folken'];
            var all = [];
            results.forEach(function(r, idx) {
                if (r.status === 'fulfilled') {
                    all = all.concat(r.value);
                    setSource(srcKeys[idx], 'ok');
                } else {
                    console.warn(srcKeys[idx] + ' scrape failed:', r.reason);
                    setSource(srcKeys[idx], 'error');
                }
            });

            if (!all.length) { renderEvents(FALLBACK_EVENTS); return; }

            var nowStr = new Date().toISOString().substring(0, 10);
            all = all.filter(function(e) { return e.date && e.date.substring(0, 10) >= nowStr; });
            all.sort(function(a, b) { return a.date.localeCompare(b.date); });

            var events = all.slice(0, 5).map(function(e) {
                return { icon: e.icon, date: formatISODate(e.date), title: e.title, venue: e.venue, image: e.image || '' };
            });

            renderEvents(events.length ? events : FALLBACK_EVENTS);
        } catch (e) {
            console.warn('Events scrape error:', e);
            setSource('konserthus', 'error');
            setSource('folken', 'error');
            renderEvents(FALLBACK_EVENTS);
        }
    }

    setTimeout(function() { loadEvents(); }, 14000);
    setInterval(loadEvents, CONFIG.eventsRefresh);

    /* ═══ BUS DEPARTURES (Entur) ═══ */
    var busEl = document.getElementById('bus-list');
    var BUS_QUERY = '{stopPlace(id:"' + CONFIG.busStop + '"){name estimatedCalls(timeRange:3600,numberOfDepartures:' + CONFIG.busDepartures + '){expectedDepartureTime aimedDepartureTime realtime destinationDisplay{frontText}serviceJourney{line{publicCode transportMode}}}}}';

    function formatBusTime(isoStr) {
        var dep = new Date(isoStr);
        var now = new Date();
        var diffMs = dep - now;
        var diffMin = Math.round(diffMs / 60000);
        if (diffMin <= 0) return 'N\u00e5';
        if (diffMin < 60) return diffMin + ' min';
        return String(dep.getHours()).padStart(2, '0') + ':' + String(dep.getMinutes()).padStart(2, '0');
    }

    function renderBusDepartures(calls) {
        busEl.innerHTML = '';
        if (!calls.length) {
            busEl.innerHTML = '<div style="color:var(--text-dim);font-size:0.85rem;">Ingen avganger</div>';
            return;
        }
        calls.forEach(function(c) {
            var line = c.serviceJourney.line.publicCode;
            var dest = c.destinationDisplay.frontText;
            var timeStr = formatBusTime(c.expectedDepartureTime);
            var isRt = c.realtime;
            var div = document.createElement('div');
            div.className = 'bus-item';
            div.innerHTML =
                '<div class="bus-line">' + escapeHtml(line) + '</div>' +
                '<div class="bus-dest">' + escapeHtml(dest) + '</div>' +
                '<div class="bus-time">' + (isRt ? '<span class="bus-rt"></span>' : '') + timeStr + '</div>';
            busEl.appendChild(div);
        });
    }

    async function loadBusDepartures() {
        setSource('buss', 'loading');
        try {
            var resp = await fetch('https://api.entur.io/journey-planner/v3/graphql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ET-Client-Name': 'pelifix-infoscreen',
                },
                body: JSON.stringify({ query: BUS_QUERY }),
            });
            if (!resp.ok) throw new Error('Entur API failed');
            var data = await resp.json();
            var sp = data.data.stopPlace;
            var calls = sp.estimatedCalls || [];
            document.getElementById('bus-stop-name').textContent = sp.name;
            renderBusDepartures(calls);
            setSource('buss', 'ok');
        } catch (e) {
            console.warn('Bus departures error:', e);
            setSource('buss', 'error');
        }
    }

    setTimeout(function() { loadBusDepartures(); }, 16000);
    setInterval(loadBusDepartures, CONFIG.busRefresh);

    /* ═══ TICKER ═══ */
    var tickerEl = document.getElementById('ticker-content');
    var tkHeadlines = [];
    var tkFinancial = [];
    var tkOffset = 0;
    var tkWidth = 0;
    var tkRunning = false;

    function buildTickerContent() {
        if (!tkHeadlines.length && !tkFinancial.length) return;
        var parts = [];
        var newsIdx = 0;
        var chunk = 5;

        while (newsIdx < tkHeadlines.length) {
            var slice = tkHeadlines.slice(newsIdx, newsIdx + chunk);
            slice.forEach(function(h) {
                parts.push('<span>' + h + '</span>');
                parts.push('<span class="sep">\u25C6</span>');
            });
            newsIdx += chunk;

            if (tkFinancial.length) {
                parts.push('<span class="sep">\u25C6</span>');
                tkFinancial.forEach(function(f) {
                    parts.push('<span class="fin-item"><span class="fin-val">' + f.value + '</span><span class="fin-cur">' + f.label + '</span></span>');
                });
                parts.push('<span class="sep">\u25C6</span>');
            }
        }

        var html = parts.join('');
        tickerEl.innerHTML = html + html;
        tickerEl.style.transform = 'translateX(0)';
        tkWidth = tickerEl.scrollWidth / 2;
        tkOffset = 0;
        if (!tkRunning) { tkRunning = true; animTicker(); }
    }

    function animTicker() {
        tkOffset -= CONFIG.tickerSpeed;
        if (Math.abs(tkOffset) >= tkWidth) tkOffset += tkWidth;
        tickerEl.style.transform = 'translateX(' + tkOffset + 'px)';
        requestAnimationFrame(animTicker);
    }

    async function loadTicker() {
        setSource('ticker', 'loading');
        try {
            var url = CONFIG.rssApi + encodeURIComponent(CONFIG.feeds.news);
            var resp = await fetch(url);
            if (!resp.ok) throw new Error('Ticker RSS failed');
            var data = await resp.json();
            if (data.status !== 'ok' || !data.items || !data.items.length) throw new Error('No ticker items');
            var hds = data.items.slice(0, 20).map(function(item) {
                return item.title ? item.title.trim() : '';
            }).filter(Boolean);
            if (hds.length) { tkHeadlines = hds; buildTickerContent(); }
            setSource('ticker', hds.length ? 'ok' : 'error');
        } catch (e) {
            console.warn('Ticker error:', e);
            setSource('ticker', 'error');
            if (!tkHeadlines.length) { tkHeadlines = ['Henter nyheter\u2026']; buildTickerContent(); }
        }
    }

    async function loadFinancialData() {
        setSource('marked', 'loading');
        try {
            var nbUrl = 'https://data.norges-bank.no/api/data/EXR/B.USD+EUR+GBP.NOK.SP?format=sdmx-json&lastNObservations=1';
            var url = CONFIG.corsProxy + encodeURIComponent(nbUrl);
            var resp = await fetch(url);
            if (!resp.ok) throw new Error('Norges Bank API failed');
            var data = await resp.json();

            var ds = data.data.dataSets[0];
            var dims = data.data.structure.dimensions.series;
            var curDim = null;
            for (var di = 0; di < dims.length; di++) {
                if (dims[di].id === 'BASE_CUR') { curDim = dims[di]; break; }
            }
            if (!curDim) throw new Error('Missing BASE_CUR dimension');

            var rates = {};
            var seriesKeys = Object.keys(ds.series);
            seriesKeys.forEach(function(key) {
                var indices = key.split(':');
                var curIdx = parseInt(indices[1]);
                var curCode = curDim.values[curIdx].id;
                var obs = ds.series[key].observations;
                var lastKey = Object.keys(obs).sort(function(a,b) { return parseInt(a) - parseInt(b); }).pop();
                rates[curCode] = obs[lastKey][0];
            });

            tkFinancial = [];
            if (rates.USD) tkFinancial.push({ label: 'USD/NOK', value: Number(rates.USD).toFixed(2) });
            if (rates.EUR) tkFinancial.push({ label: 'EUR/NOK', value: Number(rates.EUR).toFixed(2) });
            if (rates.GBP) tkFinancial.push({ label: 'GBP/NOK', value: Number(rates.GBP).toFixed(2) });
            tkFinancial.push({ label: 'Brent', value: '$74.8' });
            tkFinancial.push({ label: 'OSEBX', value: '1 472' });
            buildTickerContent();
            setSource('marked', 'ok');
        } catch (e) {
            console.warn('Financial data error:', e);
            setSource('marked', 'error');
            tkFinancial = [
                { label: 'USD/NOK', value: '\u2013' },
                { label: 'EUR/NOK', value: '\u2013' },
                { label: 'Brent', value: '$74.8' },
                { label: 'OSEBX', value: '1 472' },
            ];
            buildTickerContent();
        }
    }

    // Stagger ticker + finance (after feeds finish)
    setTimeout(function() { loadTicker(); }, 10000);
    setTimeout(function() { loadFinancialData(); }, 12000);
    setInterval(loadTicker, CONFIG.feedRefresh);
    setInterval(loadFinancialData, CONFIG.financeRefresh);

    /* ═══ WEATHER ═══ */
    var WX = {
        clearsky: ['\u2600\uFE0F','Klarvær'], fair: ['\uD83C\uDF24\uFE0F','Lettskyet'],
        partlycloudy: ['\u26C5','Delvis skyet'], cloudy: ['\u2601\uFE0F','Skyet'],
        lightrainshowers: ['\uD83C\uDF26\uFE0F','Lette regnbyger'], rainshowers: ['\uD83C\uDF26\uFE0F','Regnbyger'],
        heavyrainshowers: ['\uD83C\uDF27\uFE0F','Kraftige regnbyger'],
        lightrain: ['\uD83C\uDF27\uFE0F','Lett regn'], rain: ['\uD83C\uDF27\uFE0F','Regn'],
        heavyrain: ['\uD83C\uDF27\uFE0F','Kraftig regn'],
        lightsleetshowers: ['\uD83C\uDF28\uFE0F','Lette sluddbyger'], sleetshowers: ['\uD83C\uDF28\uFE0F','Sluddbyger'],
        lightsleet: ['\uD83C\uDF28\uFE0F','Lett sludd'], sleet: ['\uD83C\uDF28\uFE0F','Sludd'],
        lightsnowshowers: ['\uD83C\uDF28\uFE0F','Lette sn\u00f8byger'], snowshowers: ['\u2744\uFE0F','Sn\u00f8byger'],
        lightsnow: ['\u2744\uFE0F','Lett sn\u00f8'], snow: ['\u2744\uFE0F','Sn\u00f8'], heavysnow: ['\u2744\uFE0F','Kraftig sn\u00f8'],
        lightrainandthunder: ['\u26C8\uFE0F','Regn og torden'], rainandthunder: ['\u26C8\uFE0F','Regn og torden'],
        fog: ['\uD83C\uDF2B\uFE0F','T\u00e5ke'],
    };

    function wxLookup(code) {
        var base = code.replace(/_(day|night|polartwilight)$/, '');
        return WX[base] || ['\u2601\uFE0F', code];
    }

    function windDesc(ms) {
        if (ms < 0.3) return 'Stille';
        if (ms < 3.4) return 'Svak vind';
        if (ms < 8.0) return 'Moderat vind';
        if (ms < 13.9) return 'Frisk vind';
        if (ms < 20.8) return 'Liten storm';
        return 'Storm';
    }

    async function loadWeather() {
        setSource('vaer', 'loading');
        try {
            var url = 'https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=' + CONFIG.weatherLat + '&lon=' + CONFIG.weatherLon;
            var resp = await fetch(url, { headers: { 'User-Agent': 'EnergyXInfoScreen/1.0' } });
            if (!resp.ok) throw new Error('Weather failed');
            var data = await resp.json();
            var ts = data.properties.timeseries[0];
            var inst = ts.data.instant.details;
            var temp = Math.round(inst.air_temperature);
            var wind = inst.wind_speed;
            var fc = ts.data.next_1_hours || ts.data.next_6_hours;
            var sym = wxLookup(fc ? fc.summary.symbol_code : 'cloudy');
            document.getElementById('weather-icon').textContent = sym[0];
            document.getElementById('weather-temp').textContent = temp + '\u00B0';
            document.getElementById('weather-desc').textContent = sym[1];
            document.getElementById('weather-detail').textContent = windDesc(wind) + ' ' + wind.toFixed(1) + ' m/s';
            document.getElementById('weather-location').textContent = CONFIG.weatherLocation;
            setSource('vaer', 'ok');
        } catch (e) {
            console.warn('Weather error:', e);
            document.getElementById('weather-desc').textContent = 'Feil ved lasting';
            setSource('vaer', 'error');
        }
    }

    setTimeout(function() { loadWeather(); }, 18000);
    setInterval(loadWeather, CONFIG.weatherRefresh);

    /* ═══ IMAGE SLIDESHOW LOADER ═══ */
    setTimeout(function() { loadImages(); }, 22000);
    setInterval(loadImages, CONFIG.imageRefresh);

    /* ═══ LOADING ═══ */
    window.addEventListener('load', function() {
        setTimeout(function() {
            document.getElementById('loading').classList.add('hidden');
        }, 1500);
    });

})();
</script>

</body>
</html>
